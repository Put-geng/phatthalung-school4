<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โรงเรียนพัทลุง</title>
    <link rel="stylesheet" href="CodeCSS/nav-bar.css">
    <link rel="icon" href="photo-Class/favicon-logo.png" type="image/png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="CodeCSS/check-class.css">
    <style>
        .bg {
          background: url('photo-Class/Res-background.jpg')no-repeat center center/cover;
          filter: blur(1px) brightness(110%);
        }
    </style>
</head>
<body>
    <div class="bg"></div>

    <!--nav-bar-->
    <nav>
        <div class="navlogo">
            <img src="photo-Class/favicon-logo.png" alt="icon-image" class="nav-logo-img">
            <div class="nav-logo">โรงเรียนพัทลุง</div>
        </div>

        <div class="menu-icon" id="menu-icon">
            <span class="material-symbols-outlined hamberger-icon">dehaze</span>
        </div>

        <div class="nav-link" id="nav-link">
            <a href="leader-password.html">
                <span class="material-symbols-outlined nav-icon food">lock_person</span>หัวหน้าห้องเรียน
            </a>
            <a href="Check-class.html" class="nav-link-active">
                <span class="material-symbols-outlined nav-icon">browse_gallery</span>ตรวจห้องเรียน
            </a>
            <a href="" id="NameUser" class="no-after">
                <span class="material-symbols-outlined nav-icon">account_box</span>ชื่อผู้ใช้
            </a>
        </div>
    </nav>

	<!--header-->
	<div class="inline-head-for-check">
		<div class="green-for-check">ตรวจสอบเวลาว่างของ</div><div class="yellow-for-check">อาคารและห้องเรียนต่างๆ</div>
	</div>

  <div class="timecurrent" id="timecurrent"></div>
  
  <div class="container-dropdown">
    <label for="dropdownBtn">เลือกอาคาร :</label>
    <div class="custom-dropdown">
      <button id="dropdownBtn"></button>
      <div class="dropdown-content">
        <div class="option" data-value="building-1">อาคาร 1</div>
        <div class="divider"></div>
        <div class="option" data-value="building-2">อาคาร 2</div>
        <div class="divider"></div>
        <div class="option" data-value="building-3">อาคาร 3</div>
        <div class="divider"></div>
        <div class="option" data-value="building-4">อาคาร 4</div>
        <div class="divider"></div>
        <div class="option" data-value="building-5">อาคาร 5</div>
        <div class="divider"></div>
        <div class="option" data-value="building-multipurpose">อาคารอเนกประสงค์</div>
      </div>
    </div>
  </div>



    <!-- อาคารต่างๆ -->
    <section class="building">
        <h2>อาคาร 1</h2>
        <div id="building-1" class="rooms"></div>
    </section>

    <section class="building">
        <h2>อาคาร 2</h2>
        <div id="building-2" class="rooms"></div>
    </section>

    <section class="building">
        <h2>อาคาร 3</h2>
        <div id="building-3" class="rooms"></div>
    </section>

    <section class="building">
      <h2>อาคาร 4</h2>
      <div id="building-4" class="rooms"></div>
    </section>

    <section class="building">
      <h2>อาคาร 5</h2>
      <div id="building-5" class="rooms"></div>
    </section>

    <section class="building">
        <h2>อาคารอเนกประสงค์</h2>
        <div id="building-multipurpose" class="rooms"></div>
    </section>
    

    <!--alert-box-->
	<div id="alertBox" class="custom-alert">
		<img id="alertIcon" src="" alt="alertIcon" class="alert-icon">
		<span id="alertMessage" class="alertMessage"></span>
		<button id="alertOkBtn">OK</button>
    <button id="backbutton"><a href="index.html">กลับหน้า Login</a></button>
	</div>


    <script type="module" src="CodeJS/building-data.js"></script>

    <script type="module">
      import { buildings } from "./CodeJS/building-data.js";
      import { manualRooms } from "./CodeJS/building-data.js";
      import { getRoomStatus } from "./CodeJS/room-manager.js";

      async function checkRoom(buildingId, roomName, autoScheduleStatus) {
        const roomId = buildingId + "_" + roomName;
      
        const manual = await getRoomStatus(roomId);
      
        // ถ้ามีโหมด manual → ใช้ข้อมูลที่หัวหน้าห้องตั้งไว้
        if (manual && manual.mode === "manual") {
          return {
            status: manual.status,
            source: "manual",
            untilTime: manual.untilTime || null
          };
        }
      
        // ถ้าไม่มี manual → ให้ใช้ Auto แบบเดิมที่น้องเขียนไว้
        return {
          status: autoScheduleStatus,
          source: "auto"
        };
      }

      document.getElementById('menu-icon').onclick = function() {
			  document.getElementById('nav-link').classList.toggle('active');
		  }

        /*ส่วนฟังชันเข้าสู่ระบบ*/
		  const form = document.querySelector('form');
		  const nameUser = document.getElementById('NameUser');

        /*ถ้ามีข้อมูลอยู่แล้ว (เช่น reload หน้า) ให้ดึงกลับมาแสดง*/
      window.addEventListener('load', function() {
			  const savedEmailNumber = localStorage.getItem('email');
			  if (savedEmailNumber) {
				  nameUser.innerHTML = `<span class="material-symbols-outlined">account_box</span>${savedEmailNumber}`;
			  } else {
				  nameUser.innerHTML = `
					  <span class="material-symbols-outlined">account_box</span>ชื่อผู้ใช้
				  `;
			  }
		  });
		
		
		  /*เมื่อกดที่ชื่อผู้ใช้ ให้แสดงข้อมูลที่กรอกไว้*/
		  nameUser.addEventListener("click", function(e) {
		  	e.preventDefault();
		  	const savedName = localStorage.getItem('username') || "ไม่พบชื่อผู้ใช้";
		  	const savedEmail = localStorage.getItem('email') || "ไม่พบอีเมล";
		  	showAlert(`ชื่อผู้ใช้ : ${savedName}\n อีเมล : ${savedEmail}`, "success");
		  });
		
		
		
		  function showAlert(message, type="success", redirecURL=null) {
		  	const alertBox = document.getElementById('alertBox');
		  	const alertMessage = document.getElementById('alertMessage');
		  	const alertBtn = document.getElementById('alertOkBtn');
		  	const alertIcon = document.getElementById('alertIcon');
        const backbutton = document.getElementById('backbutton');
      
		  	alertMessage.textContent = message;
      
		  	if (type === "error") {
		  		alertIcon.src = "https://cdn-icons-png.flaticon.com/512/1828/1828843.png";
		  		alertBox.className = "custom-alert show error"
		  	} else {
		  		alertIcon.src = "https://cdn-icons-png.flaticon.com/512/845/845646.png";
		  		alertBox.className = "custom-alert show"
          backbutton.className = "show"
		  	}
			
		  	alertBtn.onclick = () => {
		  		alertBox.classList.remove('show');

		  		if (redirecURL) {
		  			window.location.href = redirecURL;
		  		}
		  	}
		  }
      
      
      // ✅ ฟังก์ชันเวลา
      function getSecondsSinceMidnight() {
        const now = new Date();
        return now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      }
      
      // ✅ แสดงชั่วโมง/นาที/วินาที ถูกต้อง
      function formatCountdown(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${h > 0 ?  h.toString().padStart(2, '0') + " ชั่วโมง" : ""} ${m > 0 ? m.toString().padStart(2, '0') + " นาที" : ""} ${s.toString().padStart(2, '0')} วินาที`;
      }
      
      // ✅ ฟังก์ชันหลัก
      /*
      function updateAllBuildings() {
        const days = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];
        const today = days[new Date().getDay()];
        const now = getSecondsSinceMidnight();
      
        for (const [buildingId, rooms] of Object.entries(buildings)) {
          const container = document.getElementById(buildingId);
          container.innerHTML = "";
        
          for (const [roomName, times] of Object.entries(rooms)) {
            let status = "ว่าง";
            let className = "free";
            let countdown = "";
            let currentClass = "";
            let currentSubject = "";
            let nextClass = "";
            let nextSubject = "";
            let soonestStart = null;
          
            for (const t of times) {
              if (t.day !== today && t.day !== "ทุกวัน") continue;
            
              const [sh, sm] = t.start.split(":").map(Number);
              const [eh, em] = t.end.split(":").map(Number);
              const startSec = sh * 3600 + sm * 60;
              const endSec = eh * 3600 + em * 60;
            
              if (now >= startSec && now < endSec) {
                status = "ไม่ว่าง";
                className = "busy";
                countdown = `จะว่างอีกใน ${formatCountdown(endSec - now)}`;
                currentClass = t.class;
                currentSubject = t.subject;
                break;
              } else if (now < startSec) {
                if (!soonestStart || startSec < soonestStart.startSec) {
                  soonestStart = { ...t, startSec };
                }
              }
            } 
          
            if (status === "ว่าง" && soonestStart) {
              countdown = `จะไม่ว่างในอีก ${formatCountdown(soonestStart.startSec - now)}`;
              nextClass = soonestStart.class;
              nextSubject = soonestStart.subject;
            }
          
            const div = document.createElement("div");
            div.className = `room ${className}`;
            div.innerHTML = `
              <h3>${roomName}</h3>
              <p>${status}</p>
              ${currentClass ? `<p>ชั้นเรียน: ${currentClass}</p><p>วิชา: ${currentSubject}</p>` : ""}
              ${!currentClass && nextClass ? `<p>ชั้นเรียนถัดไป: ${nextClass}</p><p>วิชา: ${nextSubject}</p>` : ""}
              <p>${countdown}</p>
            `;
            container.appendChild(div);
          }
        }
      } */

/*
      let isUpdating = false;

      async function updateAllBuildings() {
        if (isUpdating) return;
        isUpdating = true;
      
        const days = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];
        const today = days[new Date().getDay()];
        const now = getSecondsSinceMidnight();
      
        // 1) เตรียม Promise ทั้งหมดก่อน (โหลดพร้อมกัน)
        const roomPromises = [];
      
        for (const [buildingId, rooms] of Object.entries(buildings)) {
          for (const [roomName] of Object.entries(rooms)) {
            const roomId = buildingId + "_" + roomName;
            roomPromises.push(getRoomStatus(roomId));
          }
        }
      
        // 2) รอดึงสถานะทุกห้องพร้อมกัน
        const allRoomStatuses = await Promise.all(roomPromises);
      
        // index สำหรับหยิบ manual จาก array
        let statusIndex = 0;
      
        // 3) Render ห้องทั้งหมด
        for (const [buildingId, rooms] of Object.entries(buildings)) {
        
          const container = document.getElementById(buildingId);
          container.innerHTML = "";
        
          for (const [roomName, times] of Object.entries(rooms)) {
          
            // manual ถูกโหลดไว้แล้ว ไม่ต้อง await ซ้ำอีก!!!
            const manual = allRoomStatuses[statusIndex++];

            let status = "ว่าง";
            let className = "free";
            let countdown = "";
            let currentClass = "";
            let currentSubject = "";
            let nextClass = "";
            let nextSubject = "";
            let soonestStart = null;
          
          
            // ---------- MANUAL ----------
            if (manual && manual.mode === "manual") {
            
              const nowDate = new Date();
              const until = new Date(manual.untilTime);
            
              if (nowDate < until) {
                status = manual.status === "busy" ? "ไม่ว่าง" : "ว่าง";
                className = manual.status === "busy" ? "busy" : "free";
              
                const remaining = Math.floor((until - nowDate) / 1000);
                countdown = `(โหมดหัวหน้าห้อง) จะสิ้นสุดใน ${formatCountdown(remaining)}`;
              }
            
            } else {
              // ---------- AUTO ORIGINAL ----------
              for (const t of times) {
                if (t.day !== today && t.day !== "ทุกวัน") continue;
              
                const [sh, sm] = t.start.split(":").map(Number);
                const [eh, em] = t.end.split(":").map(Number);
                const startSec = sh * 3600 + sm * 60;
                const endSec = eh * 3600 + em * 60;
              
                if (now >= startSec && now < endSec) {
                  status = "ไม่ว่าง";
                  className = "busy";
                  countdown = `จะว่างอีกใน ${formatCountdown(endSec - now)}`;
                  currentClass = t.class;
                  currentSubject = t.subject;
                  break;
                } else if (now < startSec) {
                  if (!soonestStart || startSec < soonestStart.startSec) {
                    soonestStart = { ...t, startSec };
                  }
                }
              }
            
              if (status === "ว่าง" && soonestStart) {
                countdown = `จะไม่ว่างในอีก ${formatCountdown(soonestStart.startSec - now)}`;
                nextClass = soonestStart.class;
                nextSubject = soonestStart.subject;
              }
            }
          
          
            // ---------- Create DOM ----------
            const div = document.createElement("div");
            div.className = `room ${className}`;
            div.innerHTML = `
              <h3>${roomName}</h3>
              <p>${status}</p>
              ${currentClass ? `<p>ชั้นเรียน: ${currentClass}</p><p>วิชา: ${currentSubject}</p>` : ""}
              ${!currentClass && nextClass ? `<p>ชั้นเรียนถัดไป: ${nextClass}</p><p>วิชา: ${nextSubject}</p>` : ""}
              <p>${countdown}</p>
            `;
            container.appendChild(div);
          
          }
        }
      
        isUpdating = false;
      }


      async function loopUpdate() {
        await updateAllBuildings();
        setTimeout(loopUpdate, 1000);
      }

      loopUpdate();
      */

      
      let isUpdating = false;

      // โหลด manual ของทุกห้องครั้งเดียว
      async function loadAllManualRooms() {
          const roomPromises = [];
          for (const [buildingId, rooms] of Object.entries(buildings)) {
              for (const [roomName] of Object.entries(rooms)) {
                  const roomId = buildingId + "_" + roomName;
                  roomPromises.push(getRoomStatus(roomId));
              }
          }
          const allRoomStatuses = await Promise.all(roomPromises);
        
          // สร้าง object เก็บ manual ข้อมูลแบบ key-value
          let statusIndex = 0;
          const manualMap = {};
          for (const [buildingId, rooms] of Object.entries(buildings)) {
              for (const [roomName] of Object.entries(rooms)) {
                  const roomId = buildingId + "_" + roomName;
                  manualMap[roomId] = allRoomStatuses[statusIndex++];
              }
          }
          return manualMap;
      }

      async function updateAllBuildings() {
          if (isUpdating) return;
          isUpdating = true;
      
          const manualMap = await loadAllManualRooms(); // โหลด manual ครั้งเดียว
          const days = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];
          const today = days[new Date().getDay()];
          const now = getSecondsSinceMidnight();
      
          for (const [buildingId, rooms] of Object.entries(buildings)) {
              const container = document.getElementById(buildingId);
              container.innerHTML = "";
          
              for (const [roomName, times] of Object.entries(rooms)) {
                  const roomId = buildingId + "_" + roomName;
                  const manual = manualMap[roomId];
              
                  let status = "ว่าง";
                  let className = "free";
                  let countdown = "";
                  let currentClass = "";
                  let currentSubject = "";
                  let nextClass = "";
                  let nextSubject = "";
                  let soonestStart = null;
              
                  // ---------- MANUAL ----------
                  if (manual && manual.mode === "manual") {
                      const nowDate = new Date();
                      const until = new Date(manual.untilTime);
                  
                      if (nowDate < until) {
                          status = manual.status === "busy" ? "ไม่ว่าง" : "ว่าง";
                          className = manual.status === "busy" ? "busy" : "free";
                      
                          const remaining = Math.floor((until - nowDate) / 1000);
                          countdown = `(โหมดหัวหน้าห้อง) จะสิ้นสุดใน ${formatCountdown(remaining)}`;
                      }
                  } else {
                      // ---------- AUTO ORIGINAL ----------
                      for (const t of times) {
                          if (t.day !== today && t.day !== "ทุกวัน") continue;
                      
                          const [sh, sm] = t.start.split(":").map(Number);
                          const [eh, em] = t.end.split(":").map(Number);
                          const startSec = sh * 3600 + sm * 60;
                          const endSec = eh * 3600 + em * 60;
                      
                          if (now >= startSec && now < endSec) {
                              status = "ไม่ว่าง";
                              className = "busy";
                              countdown = `จะว่างอีกใน ${formatCountdown(endSec - now)}`;
                              currentClass = t.class;
                              currentSubject = t.subject;
                              break;
                          } else if (now < startSec) {
                              if (!soonestStart || startSec < soonestStart.startSec) {
                                  soonestStart = { ...t, startSec };
                              }
                          }
                      }
                    
                      if (status === "ว่าง" && soonestStart) {
                          countdown = `จะไม่ว่างในอีก ${formatCountdown(soonestStart.startSec - now)}`;
                          nextClass = soonestStart.class;
                          nextSubject = soonestStart.subject;
                      }
                  }
                
                  // ---------- Create DOM ----------
                  const div = document.createElement("div");
                  div.className = `room ${className}`;
                  div.innerHTML = `
                    <h3>${roomName}</h3>
                    <p>${status}</p>
                    ${currentClass ? `<p>ชั้นเรียน: ${currentClass}</p><p>วิชา: ${currentSubject}</p>` : ""}
                    ${!currentClass && nextClass ? `<p>ชั้นเรียนถัดไป: ${nextClass}</p><p>วิชา: ${nextSubject}</p>` : ""}
                    <p>${countdown}</p>
                  `;
                  container.appendChild(div);
              }
          }
        
          isUpdating = false;
      }

      // Loop update
      async function loopUpdate() {
          await updateAllBuildings();
          setTimeout(loopUpdate, 1000);
      }

      loopUpdate();
      



      
      //updateAllBuildings();
      //setInterval(updateAllBuildings, 1000);

      function addtimecurrent() {
        const time = document.getElementById('timecurrent');
        const days = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];
        const today = days[new Date().getDay()];
        const seconds = getSecondsSinceMidnight();
        const months = [
          "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
          "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
        ];

        const now = new Date();

        const date = now.getDate();
        const month = months[now.getMonth()];
        const year = now.getFullYear() + 543;
        const h = now.getHours().toString().padStart(2, '0');
        const m = now.getMinutes().toString().padStart(2, '0');
        const s = now.getSeconds().toString().padStart(2, '0');

        time.innerHTML = `
          <h2>วัน${today} ที่ ${date} ${month} พ.ศ.${year} เวลา ${h} : ${m} : ${s}</h2>
        `
      }

      addtimecurrent();
      setInterval(addtimecurrent, 1000);

      const dropdownBtn = document.getElementById('dropdownBtn');
      const dropdownContent = document.querySelector('.dropdown-content');
      const options = document.querySelectorAll('.dropdown-content .option');

      dropdownBtn.addEventListener('click', () => {
        dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
      });

      options.forEach(option => {
        option.addEventListener('click', () => {
          const value = option.getAttribute('data-value');
          dropdownBtn.textContent = option.textContent; // เปลี่ยนชื่อปุ่มเป็นชื่ออาคาร
          dropdownContent.style.display = 'none';
          showSelectedBuildingCustom(value);
        });
      });

      function showSelectedBuildingCustom(selected) {
        const allBuildings = document.querySelectorAll('.building');
        allBuildings.forEach(section => {
          if (section.querySelector(`#${selected}`)) {
            section.style.display = 'block';
          } else {
            section.style.display = 'none';
          }
        });
      }

      // โหลดครั้งแรก

      window.addEventListener('load', () => {
        dropdownBtn.textContent = "อาคาร 1"; // เปลี่ยนชื่อปุ่มตอนโหลด
        showSelectedBuildingCustom('building-1'); // แสดงอาคาร 1
      });



    </script>
</body>
</html>